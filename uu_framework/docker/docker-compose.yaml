# uu_framework Docker Compose Configuration
# Use this for local development and building

services:
  # Full build service
  build:
    build:
      context: ../..
      dockerfile: uu_framework/docker/Dockerfile
    volumes:
      - ../../README.md:/app/README.md:ro        # Root README (source for landing page)
      - ../../clase:/app/clase                   # Course content (writable for README.md)
      - ../../_site:/app/_site                   # Output directory
      - ../../uu_framework/config:/app/uu_framework/config:ro
      - ../../uu_framework/docs:/app/uu_framework/docs:ro  # Documentation source
      - ../../uu_framework/scripts:/app/uu_framework/scripts:ro  # Python scripts
      - ../../uu_framework/eleventy/_data:/app/uu_framework/eleventy/_data
      - ../../uu_framework/eleventy/_includes:/app/uu_framework/eleventy/_includes:ro
      - ../../uu_framework/eleventy/.eleventy.js:/app/uu_framework/eleventy/.eleventy.js:ro
      - ../../uu_framework/eleventy/tailwind.config.js:/app/uu_framework/eleventy/tailwind.config.js:ro
      - ../../uu_framework/eleventy/src:/app/uu_framework/eleventy/src:ro
    command: ["sh", "-c", "python3 uu_framework/scripts/preprocess.py && npx @11ty/eleventy --config=uu_framework/eleventy/.eleventy.js && mkdir -p _site/css/themes && npx tailwindcss -c uu_framework/eleventy/tailwind.config.js -i uu_framework/eleventy/src/css/main.css -o _site/css/styles.css --minify && cp uu_framework/eleventy/src/css/themes/*.css _site/css/themes/ && cp clase/favicon.ico clase/apple-touch-icon.png _site/ 2>/dev/null || true && if [ -d clase/images ]; then mkdir -p _site/images && cp -r clase/images/* _site/images/; fi && find clase -name '*.pdf' | grep -v b_libros | while read pdf; do rel_path=$${pdf#clase/}; pdf_dir=$$(dirname $$rel_path); mkdir -p _site/$$pdf_dir; cp $$pdf _site/$$rel_path; done && touch _site/.nojekyll"]

  # Development server with hot reload
  dev:
    build:
      context: ../..
      dockerfile: uu_framework/docker/Dockerfile
    volumes:
      - ../../README.md:/app/README.md:ro        # Root README (source for landing page)
      - ../../clase:/app/clase                   # Course content (writable for README.md)
      - ../../_site:/app/_site
      - ../../uu_framework/config:/app/uu_framework/config:ro
      - ../../uu_framework/docs:/app/uu_framework/docs:ro  # Documentation source
      - ../../uu_framework/scripts:/app/uu_framework/scripts:ro  # Python scripts
      - ../../uu_framework/eleventy/_data:/app/uu_framework/eleventy/_data
      - ../../uu_framework/eleventy/_includes:/app/uu_framework/eleventy/_includes:ro
      - ../../uu_framework/eleventy/.eleventy.js:/app/uu_framework/eleventy/.eleventy.js:ro
      - ../../uu_framework/eleventy/tailwind.config.js:/app/uu_framework/eleventy/tailwind.config.js:ro
      - ../../uu_framework/eleventy/src:/app/uu_framework/eleventy/src:ro
    ports:
      - "3000:3000"
    environment:
      # PATH_PREFIX is auto-detected from repo.json (generated by preprocessing)
      # Override if needed: export PATH_PREFIX=/custom/ && docker compose up dev
      - PATH_PREFIX=${PATH_PREFIX:-}
    command: >
      sh -c "python3 uu_framework/scripts/preprocess.py &&
             mkdir -p _site/css/themes &&
             npx tailwindcss -c uu_framework/eleventy/tailwind.config.js -i uu_framework/eleventy/src/css/main.css -o _site/css/styles.css &&
             cp uu_framework/eleventy/src/css/themes/*.css _site/css/themes/ &&
             cp clase/favicon.ico clase/apple-touch-icon.png _site/ 2>/dev/null || true &&
             if [ -d clase/images ]; then mkdir -p _site/images && cp -r clase/images/* _site/images/; fi &&
             find clase -type d -name images | grep -v b_libros | while read img_dir; do rel_path=$${img_dir#clase/}; mkdir -p _site/$$rel_path; cp -r $$img_dir/* _site/$$rel_path/ 2>/dev/null || true; done &&
             find clase -name '*.pdf' | grep -v b_libros | while read pdf; do rel_path=$${pdf#clase/}; pdf_dir=$$(dirname $$rel_path); mkdir -p _site/$$pdf_dir; cp $$pdf _site/$$rel_path; done &&
             touch _site/.nojekyll &&
             npx @11ty/eleventy --config=uu_framework/eleventy/.eleventy.js --serve --port=3000"
    stdin_open: true
    tty: true

  # Preprocessing only (for debugging)
  preprocess:
    build:
      context: ../..
      dockerfile: uu_framework/docker/Dockerfile
    volumes:
      - ../../README.md:/app/README.md:ro        # Root README (source for landing page)
      - ../../clase:/app/clase                   # Course content (writable for README.md)
      - ../../uu_framework/docs:/app/uu_framework/docs:ro  # Documentation source
      - ../../uu_framework/scripts:/app/uu_framework/scripts:ro  # Python scripts
      - ../../uu_framework/eleventy/_data:/app/uu_framework/eleventy/_data
      - ../../uu_framework/config:/app/uu_framework/config:ro
    command: ["sh", "-c", "python3 uu_framework/scripts/preprocess.py --verbose"]

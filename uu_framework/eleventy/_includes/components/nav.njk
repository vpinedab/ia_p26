{# Sidebar navigation component with hierarchical numbering #}

{# Macro to check if URL is current or ancestor of current #}
{# Note: itemPath already has base prefix from url filter, currentUrl is raw page.url #}
{% macro isActive(itemPath, currentUrl) %}
{%- set fullCurrentUrl = currentUrl | url -%}
{%- set normalizedCurrent = fullCurrentUrl | replace("/00_index/", "/") -%}
{%- set itemPathBase = itemPath | replace("/00_index/", "/") -%}
{%- if itemPath == fullCurrentUrl or itemPath == normalizedCurrent -%}current
{%- elif fullCurrentUrl.startsWith(itemPathBase) and itemPathBase.length > 1 -%}ancestor
{%- else -%}inactive{%- endif -%}
{% endmacro %}

{# Macro for generating URL from path #}
{% macro itemUrl(item) %}
{%- if item.url -%}
{{ item.url | url }}
{%- elif item.type == "directory" and item.has_index -%}
{{ ("/" + item.path + "/00_index/") | url }}
{%- elif item.type == "directory" -%}
{%- if item.children and item.children.length > 0 -%}
{{ itemUrl(item.children[0]) }}
{%- else -%}
#
{%- endif -%}
{%- elif item.type == "file" -%}
{{ ("/" + item.path | replace(".md", "") + "/") | url }}
{%- else -%}
#
{%- endif -%}
{% endmacro %}

{# Check if item should be visible in nav #}
{% macro isVisible(item) %}
{%- if item.title and item.type == "file" and not item.name.startsWith("00_") -%}true
{%- elif item.type == "directory" and (item.has_index or (item.children and item.children.length > 0)) -%}true
{%- else -%}false{%- endif -%}
{% endmacro %}

{# Count visible children #}
{% macro countVisibleChildren(children) %}
{%- set count = 0 -%}
{%- for child in children -%}
  {%- if isVisible(child) | trim == "true" -%}
    {%- set count = count + 1 -%}
  {%- endif -%}
{%- endfor -%}
{{ count }}
{% endmacro %}

{# Recursive macro for rendering nav items with numbering #}
{% macro renderNavItem(item, prefix, index, depth, currentUrl) %}
{% set num = item.name | getNavNumber(prefix, index) %}
{% set childCount = countVisibleChildren(item.children) | trim | int %}
{% set thisUrl = itemUrl(item) | trim %}
{% set activeState = isActive(thisUrl, currentUrl) | trim %}
{% set navPath = item.path | default(item.name) %}

<div class="nav-item"
     data-nav-path="{{ navPath }}"
     data-expanded="false"
     data-depth="{{ depth }}"
     data-active="{{ activeState }}"
     role="treeitem"
     aria-expanded="false">
  <div class="flex items-start group">
    {# Expand/collapse toggle #}
    {% if childCount > 0 %}
    <button class="nav-toggle p-0.5 mt-1 rounded hover:bg-bg-tertiary text-text-muted hover:text-accent transition-colors flex-shrink-0"
            aria-label="Toggle {{ item.title | cleanNavTitle | trim | default(item.name) }}"
            onclick="toggleNavSection('{{ navPath }}')">
      <svg class="w-3 h-3 transform transition-transform nav-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
    </button>
    {% else %}
    <span class="w-4 flex-shrink-0"></span>
    {% endif %}

    {# Nav link with number and title #}
    <a href="{{ thisUrl }}"
       {% if activeState == 'current' %}aria-current="page"{% endif %}
       class="flex-1 min-w-0 flex items-baseline px-1.5 py-1 rounded text-sm transition-colors
              {% if activeState == 'current' %}bg-accent/15 text-accent border-l-2 border-accent -ml-0.5 pl-2
              {% elif activeState == 'ancestor' %}text-text bg-bg-tertiary/50
              {% else %}text-text-muted hover:text-text hover:bg-bg-tertiary{% endif %}">
      {% if not item.no_number %}
      <span class="nav-number text-xs {% if activeState == 'current' %}text-accent{% else %}text-accent-secondary{% endif %} mr-1.5 flex-shrink-0 font-mono">{{ num }}</span>
      {% endif %}
      <span class="nav-title leading-snug">{{ (item.title | cleanNavTitle) | trim | default(item.name) }}</span>
    </a>
  </div>

  {# Render children recursively #}
  {% if childCount > 0 %}
  <div class="nav-children ml-4 mt-0.5 pl-2 border-l border-border/50 space-y-0.5"
       role="group">
    {% set childIndex = 0 %}
    {% for child in item.children %}
      {% if isVisible(child) | trim == "true" %}
        {{ renderNavItem(child, num + ".", childIndex, depth + 1, currentUrl) }}
        {% set childIndex = childIndex + 1 %}
      {% endif %}
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endmacro %}

{# Task pages section #}
{% set currentFullUrl = page.url | url %}
{% set tareasUrl = '/tareas/' | url %}
{% set examenesUrl = '/examenes/' | url %}
{% set proyectosUrl = '/proyectos/' | url %}
<div class="nav-tasks mb-4 pb-3 border-b border-border/50">
  <div class="text-xs text-text-muted uppercase tracking-wide px-2 mb-2">Curso</div>
  <div class="space-y-0.5">
    <a href="{{ tareasUrl }}" class="flex items-center px-2 py-1.5 rounded text-sm transition-colors
       {% if currentFullUrl == tareasUrl %}bg-homework/15 text-homework{% else %}text-text-muted hover:text-text hover:bg-bg-tertiary{% endif %}">
      <span class="w-5 h-5 mr-2 flex items-center justify-center text-homework">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
        </svg>
      </span>
      <span>Tareas</span>
      {% if tasks.homework.length > 0 %}
      <span class="ml-auto text-xs bg-homework/20 text-homework px-1.5 py-0.5 rounded">{{ tasks.homework.length }}</span>
      {% endif %}
    </a>
    <a href="{{ examenesUrl }}" class="flex items-center px-2 py-1.5 rounded text-sm transition-colors
       {% if currentFullUrl == examenesUrl %}bg-exam/15 text-exam{% else %}text-text-muted hover:text-text hover:bg-bg-tertiary{% endif %}">
      <span class="w-5 h-5 mr-2 flex items-center justify-center text-exam">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
      </span>
      <span>Ex√°menes</span>
      {% if tasks.exams.length > 0 %}
      <span class="ml-auto text-xs bg-exam/20 text-exam px-1.5 py-0.5 rounded">{{ tasks.exams.length }}</span>
      {% endif %}
    </a>
    <a href="{{ proyectosUrl }}" class="flex items-center px-2 py-1.5 rounded text-sm transition-colors
       {% if currentFullUrl == proyectosUrl %}bg-project/15 text-project{% else %}text-text-muted hover:text-text hover:bg-bg-tertiary{% endif %}">
      <span class="w-5 h-5 mr-2 flex items-center justify-center text-project">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
        </svg>
      </span>
      <span>Proyectos</span>
      {% if tasks.projects.length > 0 %}
      <span class="ml-auto text-xs bg-project/20 text-project px-1.5 py-0.5 rounded">{{ tasks.projects.length }}</span>
      {% endif %}
    </a>
  </div>
</div>

{# Content section label #}
<div class="text-xs text-text-muted uppercase tracking-wide px-2 mb-2">Contenido</div>

{# Main navigation #}
<div class="nav-root space-y-1" role="tree" aria-label="Contenido del curso">
  {% if hierarchy and hierarchy.children %}
    {% set topIndex = 0 %}
    {% for item in hierarchy.children %}
      {% if item.title and not item.name.startsWith("??") and (item.type != "directory" or item.has_index or (item.children and item.children.length > 0)) %}
        {{ renderNavItem(item, "", topIndex, 0, page.url) }}
        {% set topIndex = topIndex + 1 %}
      {% endif %}
    {% endfor %}
  {% else %}
    <p class="text-text-muted text-sm px-2 py-4">Sin contenido</p>
  {% endif %}
</div>

<style>
  /* Children container with smooth transition */
  .nav-children {
    overflow: hidden;
    transition: max-height 0.2s ease-out, opacity 0.2s ease-out;
  }

  /* Collapsed state - hide children smoothly */
  .nav-item[data-expanded="false"] > .nav-children {
    max-height: 0;
    opacity: 0;
    pointer-events: none;
  }

  /* Expanded state - show children */
  .nav-item[data-expanded="true"] > .nav-children {
    max-height: 2000px; /* Large enough for deep nesting */
    opacity: 1;
    pointer-events: auto;
  }

  /* Arrow rotation with transition */
  .nav-arrow {
    transition: transform 0.2s ease-out;
  }
  .nav-item[data-expanded="false"] > div > button .nav-arrow { transform: rotate(0deg); }
  .nav-item[data-expanded="true"] > div > button .nav-arrow { transform: rotate(90deg); }

  /* Title wrapping for long titles */
  .nav-title {
    word-break: break-word;
    hyphens: auto;
  }

  /* Depth-based styling for visual hierarchy */
  .nav-item[data-depth="0"] > div > a { font-weight: 500; }
  .nav-item[data-depth="0"] > div > a .nav-number { font-size: 0.75rem; }

  .nav-item[data-depth="1"] > div > a .nav-number { font-size: 0.7rem; opacity: 0.8; }
  .nav-item[data-depth="2"] > div > a .nav-number { font-size: 0.65rem; opacity: 0.7; }
  .nav-item[data-depth="3"] > div > a .nav-number { font-size: 0.6rem; opacity: 0.6; }

  /* Hover highlight for the number */
  .nav-item > div > a:hover .nav-number { color: var(--color-accent); }

  /* Active state styling */
  .nav-item[data-active="current"] > div > a {
    font-weight: 600;
  }
  .nav-item[data-active="current"] > div > a .nav-number {
    opacity: 1 !important;
    font-size: inherit !important;
  }

  /* Ancestor state - keep section visible */
  .nav-item[data-active="ancestor"] > div > a {
    font-weight: 500;
  }
</style>

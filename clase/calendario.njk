---
permalink: /calendario/
title: Calendario de Tareas
layout: layouts/base.njk
---

<div class="calendar-container max-w-7xl mx-auto px-4 py-8">
  <header class="mb-8">
    <h1 class="text-3xl font-bold text-text">Calendario de Tareas</h1>
    <p class="text-text-muted">Vista de calendario de todas las tareas del curso</p>
  </header>

  <!-- View Toggle -->
  <div class="view-toggle mb-6 flex gap-2">
    <button id="btn-month-view" class="btn-view px-4 py-2 rounded font-bold transition-colors">
      [CAL] Mes
    </button>
    <button id="btn-list-view" class="btn-view px-4 py-2 rounded font-bold transition-colors">
      [LIST] Lista
    </button>
  </div>

  <!-- Month View -->
  <div id="month-view" class="calendar-month hidden">
    <header class="flex items-center justify-between mb-6">
      <button id="prev-month" class="px-4 py-2 bg-bg-secondary border border-border rounded hover:bg-bg-tertiary transition-colors">
        &lt; Anterior
      </button>
      <h2 id="month-title" class="text-2xl font-bold text-text">Loading...</h2>
      <button id="next-month" class="px-4 py-2 bg-bg-secondary border border-border rounded hover:bg-bg-tertiary transition-colors">
        Siguiente &gt;
      </button>
    </header>

    <div id="calendar-grid" class="grid grid-cols-7 gap-1 mb-6">
      <!-- Calendar grid will be generated by JavaScript -->
    </div>
  </div>

  <!-- List View -->
  <div id="list-view" class="calendar-agenda hidden">
    <div id="agenda-content">
      <!-- Agenda content will be generated by JavaScript -->
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div id="task-modal" class="fixed inset-0 bg-bg/80 backdrop-blur z-50 hidden flex items-center justify-center p-4">
    <div class="bg-bg-secondary border-2 border-border rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto shadow-2xl">
      <div class="sticky top-0 bg-bg-secondary border-b border-border p-4 flex items-center justify-between">
        <h3 id="modal-title" class="text-xl font-bold text-text"></h3>
        <button id="close-modal" class="text-text-muted hover:text-accent transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div id="modal-content" class="p-6">
        <!-- Modal content will be generated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<style>
/* Calendar Grid Styling - Using actual CSS since @apply doesn't work in <style> tags */
#calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 0.25rem;
  margin-bottom: 1.5rem;
}

.day-header {
  text-align: center;
  font-weight: 700;
  color: var(--color-text-muted);
  font-size: 0.875rem;
  padding: 0.5rem 0;
}

.day-cell {
  min-height: 6rem;
  padding: 0.5rem;
  border: 1px solid var(--color-border);
  border-radius: 0.375rem;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--color-bg);
}

.day-cell:hover {
  background: var(--color-bg-secondary);
  border-color: var(--color-accent);
}

.day-cell.out-of-month {
  background: var(--color-bg-tertiary);
  color: var(--color-text-muted);
  cursor: default;
  opacity: 0.5;
}

.day-cell.today {
  ring: 2px solid var(--color-accent);
  box-shadow: 0 0 0 2px var(--color-accent);
}

.day-number {
  display: block;
  font-size: 0.875rem;
  font-weight: 700;
  color: var(--color-text);
  margin-bottom: 0.25rem;
}

.class-topic {
  font-size: 0.7rem;
  font-weight: 600;
  color: var(--color-calendar-class);
  margin-bottom: 0.25rem;
  padding: 0.125rem 0.25rem;
  background: color-mix(in srgb, var(--color-calendar-class) 10%, transparent);
  border-radius: 0.25rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.class-topic.holiday {
  color: var(--color-calendar-holiday);
  background: color-mix(in srgb, var(--color-calendar-holiday) 10%, transparent);
}

.event-dots {
  display: flex;
  flex-wrap: wrap;
  gap: 0.25rem;
}

.event-dot {
  width: 0.5rem;
  height: 0.5rem;
  border-radius: 9999px;
}

.event-dot.homework {
  background: var(--color-homework);
}

.event-dot.exam {
  background: var(--color-exam);
}

.event-dot.project {
  background: var(--color-project);
}

.event-more {
  font-size: 0.75rem;
  color: var(--color-text-muted);
  margin-top: 0.25rem;
}

/* List View Styling */
.time-bucket {
  margin-bottom: 2rem;
}

.time-bucket h3 {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--color-accent);
  margin-bottom: 1rem;
}

.task-card {
  padding: 1rem;
  margin-bottom: 0.75rem;
  border-radius: 0.5rem;
  border-left: 4px solid;
  background: var(--color-bg-secondary);
  transition: all 0.2s;
}

.task-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px -1px color-mix(in srgb, var(--color-calendar-shadow) 30%, transparent);
}

.task-card.homework {
  border-left-color: var(--color-homework);
}

.task-card.exam {
  border-left-color: var(--color-exam);
}

.task-card.project {
  border-left-color: var(--color-project);
}

.task-type-badge {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
  font-family: 'JetBrains Mono', monospace;
  border-radius: 0.25rem;
  font-weight: 700;
}

.task-type-badge.homework {
  background: color-mix(in srgb, var(--color-homework) 20%, transparent);
  color: var(--color-homework);
}

.task-type-badge.exam {
  background: color-mix(in srgb, var(--color-exam) 20%, transparent);
  color: var(--color-exam);
}

.task-type-badge.project {
  background: color-mix(in srgb, var(--color-project) 20%, transparent);
  color: var(--color-project);
}

/* View Toggle Buttons */
.btn-view {
  background: var(--color-bg-secondary);
  color: var(--color-text);
  border: 1px solid var(--color-border);
}

.btn-view.active {
  background: var(--color-accent);
  color: var(--color-bg);
  border-color: var(--color-accent);
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .day-cell {
    min-height: 4rem;
    padding: 0.25rem;
  }

  .day-number {
    font-size: 0.75rem;
  }

  .event-dot {
    width: 0.375rem;
    height: 0.375rem;
  }
}
</style>

<script>
(function() {
  'use strict';

  // Inject tasks data from Eleventy
  const tasksData = {
    homework: {{ tasks.homework | dump | safe }},
    exams: {{ tasks.exams | dump | safe }},
    projects: {{ tasks.projects | dump | safe }}
  };

  // Inject calendar topics data
  const calendarTopics = {{ calendar_topics | dump | safe }};

  // Combine all tasks
  const allTasks = [
    ...tasksData.homework,
    ...tasksData.exams,
    ...tasksData.projects
  ];

  // Current state (Mexico City timezone)
  const MEXICO_TZ = 'America/Mexico_City';

  // Get current date in Mexico City timezone
  function getMexicoDate() {
    const now = new Date();
    const mexicoDateStr = now.toLocaleString('en-US', { timeZone: MEXICO_TZ });
    return new Date(mexicoDateStr);
  }

  // Get today's date string in Mexico City timezone (YYYY-MM-DD)
  function getTodayMexicoStr() {
    const mexicoDate = getMexicoDate();
    return mexicoDate.toISOString().split('T')[0];
  }

  let currentDate = getMexicoDate();
  let currentView = localStorage.getItem('calendar-view') || 'month';

  // Month names in Spanish
  const monthNames = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
  ];

  const dayNames = ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'];

  // Helper functions
  function groupTasksByDate(tasks) {
    const grouped = {};
    tasks.forEach(task => {
      // Handle both homework (due) and exams (date)
      const taskDate = task.due || task.date;
      if (!taskDate) return;
      if (!grouped[taskDate]) grouped[taskDate] = [];
      grouped[taskDate].push(task);
    });
    return grouped;
  }

  function groupTopicsByDate(topics) {
    const grouped = {};
    topics.forEach(topic => {
      if (!topic.date) return;
      grouped[topic.date] = topic;
    });
    return grouped;
  }

  function getCalendarDays(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startOffset = firstDay.getDay();

    const days = [];

    // Add previous month padding
    const prevMonthDays = new Date(year, month, 0).getDate();
    for (let i = startOffset - 1; i >= 0; i--) {
      days.push({
        date: `${year}-${String(month).padStart(2, '0')}-${String(prevMonthDays - i).padStart(2, '0')}`,
        day: prevMonthDays - i,
        inMonth: false
      });
    }

    // Add current month days
    for (let d = 1; d <= daysInMonth; d++) {
      days.push({
        date: `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`,
        day: d,
        inMonth: true
      });
    }

    // Add next month padding to complete the grid
    const remainingCells = 42 - days.length; // 6 weeks * 7 days
    for (let d = 1; d <= remainingCells; d++) {
      days.push({
        date: `${year}-${String(month + 2).padStart(2, '0')}-${String(d).padStart(2, '0')}`,
        day: d,
        inMonth: false
      });
    }

    return days;
  }

  function isToday(dateStr) {
    return dateStr === getTodayMexicoStr();
  }

  function formatDate(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    const day = date.getDate();
    const month = monthNames[date.getMonth()];
    return `${day} de ${month.toLowerCase()}`;
  }

  // Render month view
  function renderMonthView() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Update title
    document.getElementById('month-title').textContent =
      `${monthNames[month]} ${year}`;

    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = '';

    // Add day headers
    dayNames.forEach(day => {
      const header = document.createElement('div');
      header.className = 'day-header';
      header.textContent = day;
      calendarGrid.appendChild(header);
    });

    // Get days and group tasks/topics
    const days = getCalendarDays(year, month);
    const tasksByDate = groupTasksByDate(allTasks);
    const topicsByDate = groupTopicsByDate(calendarTopics);

    // Render each day
    days.forEach(dayInfo => {
      const cell = document.createElement('div');
      cell.className = 'day-cell';

      if (!dayInfo.inMonth) {
        cell.classList.add('out-of-month');
      }

      if (isToday(dayInfo.date)) {
        cell.classList.add('today');
      }

      cell.dataset.date = dayInfo.date;

      // Day number
      const dayNum = document.createElement('span');
      dayNum.className = 'day-number';
      dayNum.textContent = dayInfo.day;
      cell.appendChild(dayNum);

      // Class topic (if exists)
      const topicForDay = topicsByDate[dayInfo.date];
      if (topicForDay && dayInfo.inMonth) {
        const topicLabel = document.createElement('div');
        topicLabel.className = 'class-topic';

        if (topicForDay.is_holiday) {
          topicLabel.textContent = 'ðŸŒ´ Asueto';
          topicLabel.classList.add('holiday');
        } else {
          topicLabel.textContent = `Clase ${topicForDay.clase}`;
          if (topicForDay.topic) {
            topicLabel.title = topicForDay.topic;
          }
        }

        cell.appendChild(topicLabel);
      }

      // Event dots
      const tasksForDay = tasksByDate[dayInfo.date] || [];
      if (tasksForDay.length > 0) {
        const dotsContainer = document.createElement('div');
        dotsContainer.className = 'event-dots';

        const maxDots = 3;
        tasksForDay.slice(0, maxDots).forEach(task => {
          const dot = document.createElement('div');
          dot.className = `event-dot ${task.type}`;
          dot.title = `${task.id}: ${task.title}`;
          dotsContainer.appendChild(dot);
        });

        if (tasksForDay.length > maxDots) {
          const more = document.createElement('div');
          more.className = 'event-more';
          more.textContent = `+${tasksForDay.length - maxDots} mÃ¡s`;
          dotsContainer.appendChild(more);
        }

        cell.appendChild(dotsContainer);
      }

      // Click handler
      if ((tasksForDay.length > 0 || topicForDay) && dayInfo.inMonth) {
        cell.addEventListener('click', () => showDayDetails(dayInfo.date, tasksForDay, topicForDay));
      }

      calendarGrid.appendChild(cell);
    });
  }

  // Render list view
  function renderListView() {
    const today = getMexicoDate();
    today.setHours(0, 0, 0, 0); // Reset to midnight for accurate comparison
    const todayStr = getTodayMexicoStr();

    // Calculate week boundaries
    const todayDayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday

    // End of this week (Saturday)
    const endOfThisWeek = new Date(today);
    endOfThisWeek.setDate(today.getDate() + (6 - todayDayOfWeek));

    // End of next week
    const endOfNextWeek = new Date(endOfThisWeek);
    endOfNextWeek.setDate(endOfThisWeek.getDate() + 7);

    // Tomorrow
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];

    // Group tasks by time buckets
    const buckets = {
      overdue: [],
      today: [],
      tomorrow: [],
      thisWeek: [],
      nextWeek: [],
      later: []
    };

    allTasks.forEach(task => {
      // Handle both homework (due) and exams (date)
      const taskDate = task.due || task.date;
      if (!taskDate) return;

      const dueDate = new Date(taskDate + 'T00:00:00');

      if (dueDate < today) {
        buckets.overdue.push(task);
      } else if (taskDate === todayStr) {
        buckets.today.push(task);
      } else if (taskDate === tomorrowStr) {
        buckets.tomorrow.push(task);
      } else if (dueDate <= endOfThisWeek) {
        buckets.thisWeek.push(task);
      } else if (dueDate <= endOfNextWeek) {
        buckets.nextWeek.push(task);
      } else {
        buckets.later.push(task);
      }
    });

    const agendaContent = document.getElementById('agenda-content');
    agendaContent.innerHTML = '';

    const bucketTitles = {
      overdue: 'Atrasadas',
      today: `Hoy (${formatDate(todayStr)})`,
      tomorrow: 'MaÃ±ana',
      thisWeek: 'Esta semana',
      nextWeek: 'PrÃ³xima semana',
      later: 'MÃ¡s adelante'
    };

    Object.entries(buckets).forEach(([key, tasks]) => {
      if (tasks.length === 0) return;

      const section = document.createElement('section');
      section.className = 'time-bucket';

      const title = document.createElement('h3');
      title.textContent = bucketTitles[key];
      section.appendChild(title);

      tasks.forEach(task => {
        const card = createTaskCard(task);
        section.appendChild(card);
      });

      agendaContent.appendChild(section);
    });

    // Empty state
    if (allTasks.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'text-center text-text-muted py-12';
      empty.textContent = 'No hay tareas programadas';
      agendaContent.appendChild(empty);
    }
  }

  // Create task card for list view
  function createTaskCard(task) {
    const card = document.createElement('article');
    card.className = `task-card ${task.type}`;

    const badge = document.createElement('span');
    badge.className = `task-type-badge ${task.type}`;
    badge.textContent = task.type === 'homework' ? '[HW]' : task.type === 'exam' ? '[EX]' : '[PR]';

    const titleEl = document.createElement('h4');
    titleEl.className = 'text-lg font-bold text-text mt-2';
    titleEl.textContent = `${task.id}: ${task.title}`;

    const meta = document.createElement('p');
    meta.className = 'text-sm text-text-muted mt-2';
    const taskDate = task.due || task.date;
    const dateLabel = task.type === 'exam' ? 'Fecha' : 'Vence';
    const pointsText = task.points ? `<span>${task.points} puntos</span> â€¢ ` : '';
    meta.innerHTML = `
      ${pointsText}
      <span>${task.chapter || 'General'}</span> â€¢
      <span>${dateLabel}: ${formatDate(taskDate)}</span>
    `;

    const link = document.createElement('a');
    link.href = `/ia_p26${task.url}`;
    link.className = 'text-accent hover:underline text-sm mt-2 inline-block';
    link.textContent = 'Ver detalles â†’';

    card.appendChild(badge);
    card.appendChild(titleEl);
    card.appendChild(meta);
    card.appendChild(link);

    return card;
  }

  // Show day details modal
  function showDayDetails(date, tasks, topic) {
    const modal = document.getElementById('task-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');

    modalTitle.textContent = formatDate(date);
    modalContent.innerHTML = '';

    // Show topic info if exists
    if (topic) {
      const topicSection = document.createElement('div');
      topicSection.className = 'mb-6 p-4 rounded-lg border-2';

      if (topic.is_holiday) {
        topicSection.style.borderColor = 'var(--color-calendar-holiday)';
        topicSection.style.background = 'color-mix(in srgb, var(--color-calendar-holiday) 5%, transparent)';
        topicSection.innerHTML = `
          <div class="text-lg font-bold" style="color: var(--color-calendar-holiday);">ðŸŒ´ DÃ­a de asueto</div>
          <div class="text-sm text-text-muted mt-1">No hay clase</div>
        `;
      } else {
        topicSection.style.borderColor = 'var(--color-calendar-class)';
        topicSection.style.background = 'color-mix(in srgb, var(--color-calendar-class) 5%, transparent)';
        topicSection.innerHTML = `
          <div class="text-lg font-bold" style="color: var(--color-calendar-class);">Clase ${topic.clase}</div>
          <div class="text-sm text-text mt-1">${topic.topic || 'Tema por definir'}</div>
        `;
      }

      modalContent.appendChild(topicSection);
    }

    // Show tasks
    if (tasks.length > 0) {
      const tasksTitle = document.createElement('h4');
      tasksTitle.className = 'text-lg font-bold text-text mb-3';
      tasksTitle.textContent = 'Tareas del dÃ­a';
      modalContent.appendChild(tasksTitle);

      tasks.forEach(task => {
        const card = createTaskCard(task);
        modalContent.appendChild(card);
      });
    }

    modal.classList.remove('hidden');
  }

  // Event listeners
  document.getElementById('btn-month-view').addEventListener('click', () => {
    currentView = 'month';
    localStorage.setItem('calendar-view', 'month');
    updateView();
  });

  document.getElementById('btn-list-view').addEventListener('click', () => {
    currentView = 'list';
    localStorage.setItem('calendar-view', 'list');
    updateView();
  });

  document.getElementById('prev-month').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderMonthView();
  });

  document.getElementById('next-month').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderMonthView();
  });

  document.getElementById('close-modal').addEventListener('click', () => {
    document.getElementById('task-modal').classList.add('hidden');
  });

  document.getElementById('task-modal').addEventListener('click', (e) => {
    if (e.target.id === 'task-modal') {
      document.getElementById('task-modal').classList.add('hidden');
    }
  });

  // Close modal with ESC key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' || e.key === 'Esc') {
      const modal = document.getElementById('task-modal');
      if (!modal.classList.contains('hidden')) {
        modal.classList.add('hidden');
      }
    }
  });

  // Update view
  function updateView() {
    const monthView = document.getElementById('month-view');
    const listView = document.getElementById('list-view');
    const monthBtn = document.getElementById('btn-month-view');
    const listBtn = document.getElementById('btn-list-view');

    if (currentView === 'month') {
      monthView.classList.remove('hidden');
      listView.classList.add('hidden');
      monthBtn.classList.add('active');
      listBtn.classList.remove('active');
      renderMonthView();
    } else {
      monthView.classList.add('hidden');
      listView.classList.remove('hidden');
      monthBtn.classList.remove('active');
      listBtn.classList.add('active');
      renderListView();
    }
  }

  // Mobile detection and default view
  function initializeView() {
    const isMobile = window.innerWidth < 768;
    if (isMobile && !localStorage.getItem('calendar-view')) {
      currentView = 'list';
    }
    updateView();
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    initializeView();
  });

  // Responsive view switching
  window.addEventListener('resize', () => {
    if (window.innerWidth < 768 && currentView === 'month') {
      currentView = 'list';
      updateView();
    }
  });
})();
</script>
